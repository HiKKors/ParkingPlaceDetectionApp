{% extends "menu_layout_admin.html" %}

{% block title %}Админ панель — управление парковками{% endblock %}

{% block style %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=80842b69-5d43-45e4-bd58-51f372f4f673&lang=ru_RU"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
    }
    #map { flex: 3; }
    .panel {
        flex: 1;
        padding: 20px;
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input { width: 100%; padding: 8px; }
    button {
        padding: 10px;
        border: none;
        cursor: pointer;
        color: white;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block content %}

<div id="map"></div>

<div class="panel">
    <h2 id="formTitle">Добавить парковку</h2>

    <div class="form-group">
        <label>Адрес</label>
        <input id="address" readonly>
    </div>

    <div class="form-group">
        <label>Цена за час</label>
        <input id="price" type="number" min="0" step="0.1">
    </div>

    <div class="form-group">
        <label>Широта</label>
        <input id="lat" readonly>
    </div>

    <div class="form-group">
        <label>Долгота</label>
        <input id="lon" readonly>
    </div>

    <button id="saveBtn" disabled style="background:#007bff;width:100%;">
        Добавить парковку
    </button>

    <button id="cancelEditBtn" style="display:none;background:#6c757d;width:100%;margin-top:10px;">
        Отменить редактирование
    </button>
</div>

<input type="file" id="videoInput" accept="video/mp4" style="display:none;">

<script>
let map;
let placemark = null;
let editingParkingId = null;
let currentParkingId = null;

ymaps.ready(init);

function init() {
    map = new ymaps.Map("map", {
        center: [46.344315, 48.02315],
        zoom: 12,
        controls: ['searchControl']
    });

    map.events.add('click', onMapClick);

    fetch('/admin/parkings')
        .then(res => res.json())
        .then(parkings => parkings.forEach(addPlacemark));
}

function addPlacemark(parking) {
    console.log(parking.lat, parking.lon)
    const balloonContent = `
        <div style="padding:16px;min-width:380px;">
            <h3>${parking.address}</h3>
            <p><b>Цена:</b> ${parking.price_per_hour} ₽/час</p>

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                <button onclick="startAnnotation(${parking.id})" style="background:#007bff;">Разметка</button>
                <button onclick="uploadVideo(${parking.id})" style="background:#ff9800;">Видео</button>
                <button onclick="goToParkingDetail(${parking.id})" style="background:#28a745;">Подробнее</button>
                <button onclick="getReport(${parking.id})" style="background:#20c997;">Отчет</button>
                <button onclick="editParking(${parking.id}, '${parking.address}', ${parking.price_per_hour}, ${parking.lat}, ${parking.lon})"
                        style="background:#17a2b8;">Редактировать</button>
                <button onclick="deleteParking(${parking.id})" style="background:#dc3545;">Удалить</button>
            </div>
        </div>
    `;

    const pm = new ymaps.Placemark(
        [parking.lat, parking.lon],
        { balloonContent },
        { preset: 'islands#blueCircleDotIcon' }
    );

    map.geoObjects.add(pm);
}

function onMapClick(e) {
    if (editingParkingId) return;

    const coords = e.get('coords');
    if (placemark) map.geoObjects.remove(placemark);

    placemark = new ymaps.Placemark(coords, {}, { preset: 'islands#redIcon' });
    map.geoObjects.add(placemark);

    lat.value = coords[0].toFixed(6);
    lon.value = coords[1].toFixed(6);

    ymaps.geocode(coords).then(res => {
        address.value = res.geoObjects.get(0).getAddressLine();
        saveBtn.disabled = false;
    });
}

function editParking(id, addressVal, priceVal, latVal, lonVal) {
    editingParkingId = id;

    formTitle.innerText = 'Редактирование парковки';
    saveBtn.innerText = 'Сохранить изменения';
    cancelEditBtn.style.display = 'block';

    address.value = addressVal;
    price.value = price;
    lat.value = latVal;
    lon.value = lonVal;

    saveBtn.disabled = false;
}

saveBtn.onclick = () => {
    const data = {
        address: address.value,
        price_per_hour: parseFloat(price.value),
        lat: parseFloat(lat.value),
        lon: parseFloat(lon.value)
    };

    if (editingParkingId) {
        fetch(`/admin/parking/${editingParkingId}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        }).then(() => location.reload());
        return;
    }

    fetch('/admin/add-parking', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
    }).then(() => location.reload());
};

cancelEditBtn.onclick = resetForm;

function resetForm() {
    editingParkingId = null;
    placemark && map.geoObjects.remove(placemark);
    placemark = null;

    formTitle.innerText = 'Добавить парковку';
    saveBtn.innerText = 'Добавить парковку';
    saveBtn.disabled = true;
    cancelEditBtn.style.display = 'none';

    address.value = price.value = lat.value = lon.value = '';
}

function deleteParking(id) {
    if (!confirm('Удалить парковку?')) return;
    fetch(`/admin/delete_parking/${id}`, {method:'DELETE'})
        .then(() => location.reload());
}

function uploadVideo(id) {
    currentParkingId = id;
    videoInput.click();
}

videoInput.onchange = () => {
    const formData = new FormData();
    formData.append('video', videoInput.files[0]);

    fetch(`/admin/parking/${currentParkingId}/upload-video`, {
        method:'POST',
        body:formData
    }).then(() => alert('Видео загружено'));
};

function startAnnotation(id) {
    fetch(`/admin/parking/${id}/start-annotation`, {method:'POST'})
        .then(res => res.json())
        .then(d => alert(d.message || 'Разметка запущена'));
}

function goToParkingDetail(id) {
    window.location.href = `/admin/parking/${id}`;
}

function getReport(id) {
    const reportData = {
        positiveReviews: 15,
        negativeReviews: 3,
        averageRating: 4.6,
        favoritesCount: 2,
    };

    // Формируем данные для Excel
    const worksheetData = [
        ['Параметр', 'Значение'],
        ['Количество положительных отзывов', reportData.positiveReviews],
        ['Количество отрицательных отзывов', reportData.negativeReviews],
        ['Средний рейтинг', reportData.averageRating],
        ['Добавлений в избранное', reportData.favoritesCount],
    ];

    // Создание листа
    const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

    // Создание книги
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Отчет по парковке');

    // Имя файла
    const fileName = `parking_report_${new Date().toISOString().slice(0,10)}.xlsx`;

    // Скачивание
    XLSX.writeFile(workbook, fileName);

}
</script>

{% endblock %}
